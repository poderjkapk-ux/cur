importScripts('https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js');
importScripts('https://www.gstatic.com/firebasejs/8.10.1/firebase-messaging.js');

// --- 1. НАЛАШТУВАННЯ FIREBASE ---
// Ці дані повинні збігатися з тими, що у вас в templates_courier.py
firebase.initializeApp({
    apiKey: "AIzaSyC_amFOh032cBcaeo3f1woLmlwhe6Fyr_k",
    authDomain: "restifysite.firebaseapp.com",
    projectId: "restifysite",
    storageBucket: "restifysite.firebasestorage.app",
    messagingSenderId: "679234031594",
    appId: "1:679234031594:web:cc77807a88c5a03b72ec93"
});

const messaging = firebase.messaging();

/**
 * --- 2. ОБРОБКА ПОВІДОМЛЕНЬ У ФОНІ (Background Handler) ---
 * Ця функція спрацьовує, коли додаток закритий або згорнутий.
 * Ми беремо дані з payload.data, щоб сформувати сповіщення самостійно.
 */
messaging.onBackgroundMessage(function(payload) {
  console.log('[firebase-messaging-sw.js] Received background message ', payload);

  // Отримуємо дані. Якщо ключів немає, використовуємо дефолтні значення.
  // Важливо: ми використовуємо payload.data, тому що в app.py ми відправляємо дані саме туди.
  const data = payload.data || {};
  
  const notificationTitle = data.title || "Restify Courier";
  const notificationOptions = {
    body: data.body || "Нове замовлення!",
    icon: 'https://cdn-icons-png.flaticon.com/512/7542/7542190.png', // Іконка кур'єра
    
    // Тег дозволяє замінювати старі повідомлення новими (щоб не було "смітника" в шторці)
    tag: 'new-order', 
    
    // Повідомлення не зникне саме, поки користувач не натисне або не свайпне
    requireInteraction: true,
    
    // Передаємо URL, який треба відкрити при кліку
    data: { 
        url: data.url || '/courier/app',
        job_id: data.job_id
    }
  };

  return self.registration.showNotification(notificationTitle, notificationOptions);
});

/**
 * --- 3. ОБРОБКА КЛІКУ ПО ПОВІДОМЛЕННЮ ---
 * Коли кур'єр натискає на сповіщення, ми відкриваємо додаток (PWA)
 * або фокусуємося на вже відкритій вкладці.
 */
self.addEventListener('notificationclick', function(event) {
    console.log('[firebase-messaging-sw.js] Notification click received.');

    // Закриваємо повідомлення в шторці
    event.notification.close();

    // Отримуємо URL з даних повідомлення (або дефолтний)
    const urlToOpen = (event.notification.data && event.notification.data.url) || '/courier/app';

    // Магія PWA: шукаємо відкриті вікна браузера
    event.waitUntil(
        clients.matchAll({type: 'window', includeUncontrolled: true}).then(windowClients => {
            // 1. Якщо вкладка вже відкрита - фокусуємося на ній
            for (var i = 0; i < windowClients.length; i++) {
                var client = windowClients[i];
                if (client.url.indexOf(urlToOpen) !== -1 && 'focus' in client) {
                    return client.focus();
                }
            }
            // 2. Якщо вкладки немає - відкриваємо нову
            if (clients.openWindow) {
                return clients.openWindow(urlToOpen);
            }
        })
    );
});